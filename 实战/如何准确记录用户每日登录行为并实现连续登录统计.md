# å¦‚ä½•å‡†ç¡®è®°å½•ç”¨æˆ·æ¯æ—¥ç™»å½•è¡Œä¸ºå¹¶å®ç°è¿ç»­ç™»å½•ç»Ÿè®¡

---

## ğŸ“„ ç”¨æˆ·ç™»å½•è¡Œä¸ºè®°å½•ä¸è¿ç»­ç™»å½•ç»Ÿè®¡æ–¹æ¡ˆ

### ä¸€ã€èƒŒæ™¯è¯´æ˜

- ç³»ç»Ÿä½¿ç”¨ **JWTï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰** å®ç°æ— çŠ¶æ€è®¤è¯ã€‚
- å‰ç«¯åœ¨ token æœ‰æ•ˆæœŸå†…ä¸ä¼šé‡æ–°è°ƒç”¨ç™»å½•æ¥å£ã€‚
- éœ€è¦è®°å½•ç”¨æˆ·çš„**æ¯æ—¥ç™»å½•è¡Œä¸º**ï¼Œç”¨äºï¼š
  - è¿ç»­ç™»å½•å¤©æ•°ç»Ÿè®¡
  - æ´»è·ƒåº¦åˆ†æ
  - ç™»å½•å¥–åŠ±æœºåˆ¶ç­‰åœºæ™¯

---

#### äºŒã€é—®é¢˜åˆ†æ

| é¡¹ç›®      | æè¿°                                                         |
| --------- | ------------------------------------------------------------ |
| â—é—®é¢˜æ ¸å¿ƒ | ç”¨æˆ·æœªé‡æ–°ç™»å½•æ—¶ï¼Œæ— æ³•é€šè¿‡â€œç™»å½•æ¥å£â€è§¦å‘ç™»å½•è®°å½•             |
| â—å½±å“ç»“æœ | è‹¥åªä¾èµ–ç™»å½•æ¥å£è®°å½•ï¼Œä¼šå¯¼è‡´æ´»è·ƒå¤©æ•°ç»Ÿè®¡ä¸å…¨                 |
| âœ…è§£å†³æ–¹æ¡ˆ | åœ¨æ¯æ¬¡è®¿é—®å—ä¿æŠ¤æ¥å£æ—¶ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ä¸ºå½“æ—¥é¦–æ¬¡è®¿é—®ï¼Œå¹¶è¡¥è®°å½•ç™»å½•è¡Œä¸º |

---

#### ä¸‰ã€æŠ€æœ¯é€‰å‹

#### æ•°æ®å­˜å‚¨æ–¹å¼ï¼šRedis Bitmaps

- ä½¿ç”¨ Redis çš„ `SETBIT` å’Œ `GETBIT` æ“ä½œè®°å½•æ¯å¤©æ˜¯å¦ç™»å½•
- æ¯ä¸ªç”¨æˆ·ä¸€ä¸ª keyï¼Œæ ¼å¼ä¸ºï¼š`user:{userID}:login_days`
- æ¯ä¸€ä½ä»£è¡¨æŸä¸€å¤©æ˜¯å¦ç™»å½•ï¼ˆ1 è¡¨ç¤ºå·²ç™»å½•ï¼Œ0 è¡¨ç¤ºæœªç™»å½•ï¼‰

##### ç¤ºä¾‹ï¼š

```text
user:1001:login_days
bit 19234 = 1 ï¼ˆè¡¨ç¤ºç¬¬ 19234 å¤©å·²ç™»å½•ï¼‰
```

---

#### å››ã€å®ç°æ­¥éª¤

#### 1. è®¡ç®—æ—¥æœŸåç§»é‡ï¼ˆä»¥å¤©ä¸ºå•ä½ï¼‰

```go
func daysSinceEpoch() int64 {
	now := time.Now().UTC()
	return now.Unix() / 86400 // è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥èµ·çš„å¤©æ•°
}
```

#### 2. è®°å½•ç”¨æˆ·æ¯æ—¥ç™»å½•è¡Œä¸ºï¼ˆé˜²æ­¢é‡å¤ï¼‰

```go
func recordLoginOncePerDay(rdb *redis.Client, userID string) error {
	key := fmt.Sprintf("user:%s:login_days", userID)
	today := daysSinceEpoch()

	bit, err := rdb.GetBit(ctx, key, today).Result()
	if err != nil {
		return err
	}
	if bit == 1 {
		return nil // å·²è®°å½•è¿‡ä»Šå¤©
	}

	// è®¾ç½®å½“å¤©ç™»å½•æ ‡å¿—
	_, err = rdb.SetBit(ctx, key, today, 1).Result()
	if err != nil {
		return err
	}

	// å¯é€‰ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ä¿ç•™ä¸€å¹´æ•°æ®ï¼‰
	rdb.Expire(ctx, key, 365*24*time.Hour)

	return nil
}
```

#### 3. åˆ›å»ºä¸­é—´ä»¶ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚ä¸­è‡ªåŠ¨è®°å½•ç™»å½•è¡Œä¸º

é€‚ç”¨äº Ginã€Echo æˆ–å…¶ä»– Go Web æ¡†æ¶ï¼š

```go
func DailyLoginMiddleware(rdb *redis.Client) gin.HandlerFunc {
	return func(c *gin.Context) {
		userID, exists := c.Get("userID")
		if !exists {
			c.AbortWithStatusJSON(401, gin.H{"error": "unauthorized"})
			return
		}

		userIDStr, ok := userID.(string)
		if !ok {
			c.AbortWithStatusJSON(500, gin.H{"error": "invalid user id type"})
			return
		}

		err := recordLoginOncePerDay(rdb, userIDStr)
		if err != nil {
			fmt.Printf("Failed to record login for user %s: %v\n", userIDStr, err)
		}

		c.Next()
	}
}
```

> âš ï¸ æ³¨æ„ï¼šç¡®ä¿ä½ å·²ç»åœ¨ JWT éªŒè¯ä¸­é—´ä»¶ä¸­å°† `userID` æ”¾å…¥ä¸Šä¸‹æ–‡ã€‚

#### 4. æ·»åŠ è¯¥ä¸­é—´ä»¶åˆ°éœ€è¦ç»Ÿè®¡çš„æ¥å£ä¸Š

```go
api := r.Group("/api")
api.Use(JWTAuthMiddleware())       // éªŒè¯ JWTï¼Œè®¾ç½® userID
api.Use(DailyLoginMiddleware(rdb)) // è®°å½•æ¯æ—¥ç™»å½•è¡Œä¸º

{
	api.GET("/profile", profileHandler)
	api.GET("/dashboard", dashboardHandler)
	// å…¶ä»–æ¥å£...
}
```

---

### äº”ã€æŸ¥è¯¢åŠŸèƒ½å®ç°

#### 1. è·å–ç”¨æˆ·æ€»ç™»å½•å¤©æ•°ï¼ˆBITCOUNTï¼‰

```go
func getTotalLoginDays(rdb *redis.Client, userID string) (int64, error) {
	key := fmt.Sprintf("user:%s:login_days", userID)
	return rdb.BitCount(ctx, key, nil).Result()
}
```

#### 2. è·å–ç”¨æˆ·è¿ç»­ç™»å½•å¤©æ•°

```go
func getConsecutiveLoginDays(rdb *redis.Client, userID string) (int, error) {
	key := fmt.Sprintf("user:%s:login_days", userID)
	today := daysSinceEpoch()

	var consecutiveDays int
	for i := 0; i < 365; i++ {
		offset := today - int64(i)
		bit, err := rdb.GetBit(ctx, key, offset).Result()
		if err != nil {
			return 0, err
		}
		if bit == 1 {
			consecutiveDays++
		} else {
			break
		}
	}
	return consecutiveDays, nil
}
```

---

### å…­ã€ä¼˜åŒ–å»ºè®®

#### 1. ä½¿ç”¨ Lua è„šæœ¬æé«˜åŸå­æ€§å’Œæ€§èƒ½

å°† `GetBit + SetBit` æ“ä½œåˆå¹¶æˆä¸€ä¸ª Lua è„šæœ¬ï¼Œé¿å…å¹¶å‘å†™å†²çªã€‚

```lua
-- lua_script.lua
local key = KEYS[1]
local offset = tonumber(ARGV[1])

local bit = redis.call('GETBIT', key, offset)
if bit == 0 then
    redis.call('SETBIT', key, offset, 1)
    redis.call('EXPIRE', key, 31536000) -- 1å¹´
    return 1
else
    return 0
end
```

åœ¨ Go ä¸­è°ƒç”¨ï¼š

```go
script := redis.NewScript(luaScriptContent)
_, err := script.Run(ctx, rdb, []string{key}, today).Result()
```

---

### ä¸ƒã€åç»­å¯æ‰©å±•åŠŸèƒ½ï¼ˆå¦‚éœ€ï¼‰

| åŠŸèƒ½                      | è¯´æ˜                                        |
| ------------------------- | ------------------------------------------- |
| ç™»å½•å¥–åŠ±                  | åˆ¤æ–­è¿ç»­ç™»å½•å¤©æ•°è¾¾åˆ°ä¸€å®šå€¼åå‘é€å¥–åŠ±        |
| ç™»å½•æ’è¡Œæ¦œ                | ä½¿ç”¨ ZSet ç»Ÿè®¡æ¯æœˆ/æ¯å‘¨æ´»è·ƒç”¨æˆ·æ’å         |
| ç”¨æˆ·ç­¾åˆ°æ—¥å†              | è¿”å›ç”¨æˆ·åœ¨è¿‡å» n å¤©çš„ç™»å½•æƒ…å†µï¼Œå‰ç«¯å±•ç¤ºæ—¥å† |
| è‡ªåŠ¨åˆ·æ–° Token ä¹Ÿè®°å½•ç™»å½• | åœ¨ refresh token æ¥å£ä¸­åŒæ ·è§¦å‘ä¸€æ¬¡ç™»å½•è®°å½• |

---

### å…«ã€æ€»ç»“

| åŠŸèƒ½           | å®ç°æ–¹æ³•                               |
| -------------- | -------------------------------------- |
| è®°å½•æ¯æ—¥ç™»å½•   | ä½¿ç”¨ Redis Bitmapsï¼Œåœ¨ä¸­é—´ä»¶ä¸­è‡ªåŠ¨è®°å½• |
| æŸ¥è¯¢è¿ç»­ç™»å½•   | å¾ªç¯æ£€æŸ¥æœ€è¿‘æ¯å¤©çš„ bit æ˜¯å¦ä¸º 1        |
| æŸ¥è¯¢æ€»ç™»å½•å¤©æ•° | ä½¿ç”¨ `BITCOUNT` æŒ‡ä»¤                   |
| é˜²æ­¢é‡å¤è®°å½•   | ä½¿ç”¨ GetBit åˆ¤æ–­æ˜¯å¦å†™å…¥è¿‡             |
| æ€§èƒ½ä¼˜åŒ–       | ä½¿ç”¨ Lua è„šæœ¬åˆå¹¶æ“ä½œ                  |

âœ… ä½¿ç”¨è¯¥æ–¹æ¡ˆå¯ä»¥åšåˆ°ï¼š

- å‡†ç¡®ç»Ÿè®¡ç”¨æˆ·æ¯æ—¥æ´»è·ƒæƒ…å†µ
- æ”¯æŒè¿ç»­ç™»å½•å¤©æ•°è®¡ç®—
- ä¸ä¾èµ–ç”¨æˆ·é‡æ–°ç™»å½•å³å¯è®°å½•ç™»å½•è¡Œä¸º
- å†…å­˜å ç”¨å°ã€æ€§èƒ½é«˜ã€æ˜“äºç»´æŠ¤

